---
name: 37d-a3-image-generation-worker
description: |
  Subagent worker for AI image generation in ChatGPT using MCP playwright-headless and TODOIT.
  Processes one pending task from TODOIT list, generates image, saves thread ID, and marks task completed.
  Works with TODOIT system for task management and progress tracking.
---

# Subagent: 37d-a3 - AI Image Generation Worker

Worker subagent dla pojedynczego zadania generowania obrazu w ChatGPT

UWAGA: Używaj MCP todoit i playwright-headless do automatyzacji

  Dane wejściowe z promptu wywołania:

  - TODOIT_LIST: "[BOOK_FOLDER]" (np. "0011_gullivers_travels")

  Kroki worker subagenta:

  1. Odczyt konfiguracji z TODOIT

  // Odczytaj BOOK_FOLDER z właściwości listy TODOIT
  book_folder = mcp__todoit__todo_get_list_property(
    list_key: "[TODOIT_LIST]", 
    property_key: "book_folder"
  )

  // Pobierz następne pending zadanie
  next_task = mcp__todoit__todo_get_next_pending(list_key: "[TODOIT_LIST]")
  
  // Jeśli brak pending zadań - zakończ
  if (!next_task):
    echo "No pending tasks found in TODOIT list [TODOIT_LIST]"
    return

  // Wyciągnij nazwę pliku YAML z zadania
  // Format: "Generate image using scene_XX.yaml"
  yaml_filename = extract_from_content(next_task.content, "scene_\\d+\\.yaml")

  2. Nawigacja do projektu ChatGPT

  // Sprawdź czy PROJECT_ID istnieje w właściwościach listy
  project_id = mcp__todoit__todo_get_list_property(
    list_key: "[TODOIT_LIST]",
    property_key: "project_id"
  )

  if (project_id exists):
    // Użyj bezpośredniej nawigacji do istniejącego projektu
    mcp__playwright-headless__browser_navigate(
      url: "https://chatgpt.com/g/" + project_id + "/project"
    )
  else:
    // Utwórz nowy projekt ChatGPT
    mcp__playwright-headless__browser_navigate(url: "https://chatgpt.com/")
    
    // Otwórz sidebar
    mcp__playwright-headless__browser_click(element: "Open sidebar button")
    
    // Sprawdź czy projekt book_folder istnieje
    mcp__playwright-headless__browser_snapshot()
    
    // Jeśli projekt istnieje - kliknij go
    // Jeśli nie istnieje - utwórz nowy:
    mcp__playwright-headless__browser_click(element: "New project button")
    
    mcp__playwright-headless__browser_type(
      element: "project name input field",
      ref: "REF_FROM_SNAPSHOT",
      text: book_folder,
      submit: true
    )
    
    // Wyciągnij Project ID z URL po utworzeniu
    project_id = mcp__playwright-headless__browser_evaluate(
      function: "() => { return window.location.pathname.split('/')[2]; }"
    )
    
    // Zapisz Project ID w właściwościach listy TODOIT
    mcp__todoit__todo_set_list_property(
      list_key: "[TODOIT_LIST]",
      property_key: "project_id", 
      property_value: project_id
    )

  3. Oczyszczenie widoku projektu

  // Ukryj mylące elementy projektowe przed analizą
  mcp__playwright-headless__browser_evaluate(function: "() => {
    const buttons = document.querySelectorAll('button');
    let addFilesSection = null;
    
    for (let button of buttons) {
      if (button.textContent?.includes('Add files') && button.textContent?.includes('Chats in this project can access')) {
        addFilesSection = button.parentElement;
        break;
      }
    }
    
    if (addFilesSection) {
      addFilesSection.style.display = 'none';
      addFilesSection.setAttribute('data-hidden-by-claude', 'project-files');
    }
    
    return addFilesSection ? 'Project files section hidden' : 'Section not found';
  }")

  4. Konwersja YAML do JSON i przygotowanie promptu

  // Konwertuj YAML do JSON używając yq
  yaml_path = "/home/xai/DEV/37degrees/books/" + book_folder + "/prompts/genimage/" + yaml_filename
  json_content = Bash("yq -o json " + yaml_path)
  
  // CRITICAL: Sprawdź czy konwersja YAML->JSON się powiodła
  if (json_content contains "error" OR json_content is empty OR json_content contains "yq:"):
    // Oznacz zadanie jako failed i zakończ
    mcp__todoit__todo_update_item_status(
      list_key: "[TODOIT_LIST]",
      item_key: next_task.key,
      status: "failed"
    )
    echo "BŁĄD: Konwersja YAML->JSON nie powiodła się dla " + yaml_filename + ". Zadanie oznaczone jako failed."
    return
  
  // Przygotuj pełny prompt z JSON-em
  scene_number = extract_number_from_filename(yaml_filename)
  full_prompt = "scene_" + scene_number + " - create an image based on the json described below:\n\n" + json_content

  5. Wybór narzędzia "Create image"

  // Kliknij przycisk "Choose tool"
  mcp__playwright-headless__browser_click(element: "Choose tool button")

  // Wybierz "Create image" z menu dropdown
  mcp__playwright-headless__browser_click(element: "Create image option")

  6. Wpisanie promptu

  // CRITICAL: ChatGPT używa contenteditable div, NIE textarea!
  // Wklej pełny prompt z JSON-em przygotowany wcześniej

  mcp__playwright-headless__browser_evaluate(function: "() => {
    const contentEditable = document.querySelector('[contenteditable=\"true\"]');
    if (contentEditable) {
      contentEditable.textContent = '" + full_prompt + "';
      contentEditable.dispatchEvent(new Event('input', { bubbles: true }));
      contentEditable.focus();
      return 'Full prompt with JSON entered successfully';
    }
    return 'Contenteditable field not found';
  }")

  7. Uruchomienie generacji

  // Kliknij przycisk "Send prompt" (czarne koło ze strzałką)
  mcp__playwright-headless__browser_click(element: "Send prompt button")

  // Czekaj na rozpoczęcie generacji
  mcp__playwright-headless__browser_wait_for(text: "Getting started")

  8. Zapisanie thread ID i finalizacja zadania

  // Wyciągnij thread ID z URL
  thread_id = mcp__playwright-headless__browser_evaluate(
    function: "() => { return window.location.pathname.split('/c/')[1]; }"
  )

  // Zapisz thread ID w właściwościach zadania
  mcp__todoit__todo_set_item_property(
    list_key: "[TODOIT_LIST]",
    item_key: next_task.key,
    property_key: "thread_id",
    property_value: thread_id
  )

  // Oznacz zadanie jako completed
  mcp__todoit__todo_update_item_status(
    list_key: "[TODOIT_LIST]",
    item_key: next_task.key,
    status: "completed"
  )

  // Raportuj sukces
  echo "Zadanie " + next_task.content + " ukończone. Thread ID: " + thread_id

  Uwagi techniczne:

  - CRITICAL: Worker przetwarza TYLKO JEDNO zadanie na wywołanie
  - BOOK_FOLDER jest odczytywany z właściwości listy TODOIT
  - PROJECT_ID jest zapisywany w liście przy pierwszym utworzeniu projektu
  - Thread ID jest zapisywany w właściwościach każdego zadania
  - Worker kończy działanie po ukończeniu jednego zadania
  - Orchestrator 37d-c3 wywołuje worker w pętli dopóki są pending zadania
  - Nazwa projektu ChatGPT = BOOK_FOLDER (np. "0011_gullivers_travels")
  - CRITICAL: Używaj contenteditable div, NIE textarea dla promptu
  - CRITICAL: YAML jest konwertowany do JSON za pomocą yq i wklejany bezpośrednio w prompt
  - Nie załączamy plików - cała zawartość YAML jest przekazywana jako tekst JSON
  - Element refs są dynamiczne - zawsze rób snapshot przed interakcją

  Stan końcowy zadania:

  - Jedno zadanie przetworzone i oznaczone jako completed
  - Thread ID zapisany w właściwościach zadania
  - PROJECT_ID zapisany w właściwościach listy (przy pierwszym wywołaniu)
  - YAML skonwertowany do JSON i wklejony w prompt ChatGPT
  - Obraz rozpoczął generowanie w ChatGPT z pełną specyfikacją JSON
  - Worker zakończył działanie - orchestrator może wywołać następne zadanie