---

## name: 37d-c4-todoit description

# 37d‑c4‑todoit — Pobieranie obrazów z ChatGPT na TODOIT (Properties)

## Wejście i założenia

- **Na wejsciu musi być podany BOOK_FOLDER (przykład: 0009_fahrenheit_451)** - jeśli nie ma, zakończ działanie z odpowiednim komunikatem
- **SOURCE_LIST**: `[BOOK_FOLDER]` (lista źródłowa z systemem properties)
- **Właściwości listy SOURCE**:
  - `book_folder = [BOOK_FOLDER]`
  - `project_id = g-p-...` (ID projektu ChatGPT)
- **Właściwości pozycji w SOURCE**:
  - `thread_id = ...` (ID czatu dla danej sceny)
  - `image_generated = completed|pending|in_progress|failed` (status generowania)
  - `image_downloaded = completed|pending|in_progress|failed` (status pobierania)
- **Nazewnictwo plików**: `[BOOK_FOLDER]_scene_[NN].png`, `[BOOK_FOLDER]_scene_[NN]_a.png`, ...

> Jeśli nie masz `project_id` lub `thread_id`, zatrzymaj się i napraw stan w 37d‑a3.

## Algorytm (Properties)

### 0) Ustal kontekst

```javascript
// Wejście operacyjne
const SOURCE_LIST = "[BOOK_FOLDER]";

// Właściwości listy źródłowej
const bookFolder = await mcp__todoit__todo_get_list_property({
  list_key: SOURCE_LIST, property_key: "book_folder"
});
const projectId = await mcp__todoit__todo_get_list_property({
  list_key: SOURCE_LIST, property_key: "project_id"
});
if (!bookFolder || !projectId) { throw new Error("Brak book_folder albo project_id"); }
```

### 1) Pobierz następne zadanie do pobrania

```javascript
// Znajdź pierwsze zadanie z image_downloaded=pending
const pendingDownloads = await mcp__todoit__todo_find_items_by_property({
  list_key: SOURCE_LIST,
  property_key: "image_downloaded", 
  property_value: "pending",
  limit: 1
});

if (!pendingDownloads.success || pendingDownloads.count === 0) {
  console.log("Brak zadań gotowych do pobrania"); 
  return; 
}

const nextItem = pendingDownloads.items[0];

// Sprawdź czy image_generated=completed (walidacja)
const imageGenerated = await mcp__todoit__todo_get_item_property({
  list_key: SOURCE_LIST, item_key: nextItem.item_key, property_key: "image_generated"
});

if (imageGenerated?.property_value !== "completed") {
  console.log(`Zadanie ${nextItem.item_key} nie ma ukończonego generowania`);
  return;
}

const sceneKey = nextItem.item_key;          // np. "scene_01"
const threadId = await mcp__todoit__todo_get_item_property({
  list_key: SOURCE_LIST, item_key: sceneKey, property_key: "thread_id"
});
if (!threadId?.property_value) {
  await mcp__todoit__todo_set_item_property({
    list_key: SOURCE_LIST, item_key: sceneKey, 
    property_key: "image_downloaded", property_value: "failed"
  });
  throw new Error(`Brak thread_id dla ${sceneKey}`);
}
const chatUrl = `https://chatgpt.com/g/${projectId}/c/${threadId.property_value}`;
```

### 2) Wejdź w czat i zrzutuj wszystkie obrazy

```javascript
await mcp__playwright-headless__browser_navigate({ url: chatUrl });
await mcp__playwright-headless__browser_wait_for(time: 5);
await mcp__playwright-headless__browser_snapshot();

// Pobieranie: pojedyncze odpowiedzi
await mcp__playwright-headless__browser_click({ element: "Download this image button" });

// Pobieranie: odpowiedzi wielokrotne (Previous/Next)
let moved;
do {
  // Spróbuj cofnąć do pierwszej odpowiedzi i pobrać
  moved = await mcp__playwright-headless__browser_evaluate({
    function: `() => {
      const buttons = Array.from(document.querySelectorAll('button'));
      const prev = buttons.find(b => (b.getAttribute('aria-label')||'').includes('Previous response'));
      if (prev && !prev.disabled) { prev.click(); return true; }
      return false;
    }`
  });
  await mcp__playwright-headless__browser_click({ element: "Download this image button" });
} while (moved === true);

```

### 3) Przenieś i nazwij pliki

```bash
# Miejsce zrzutów (zależnie od serwera MCP)
ls -t /tmp/playwright-mcp-files/headless/ChatGPT-Image*.png || true

SCENE_NUM=$(echo "$sceneKey" | sed -E 's/scene_([0-9]{2})/\1/')
BASE="${bookFolder}_scene_${SCENE_NUM}"
DEST_DIR="/home/xai/DEV/37degrees/books/${bookFolder}/generated"
mkdir -p "$DEST_DIR"

# Nie nadpisuj. Doklejaj sufiksy _a _b ...
move_one() {
  src="$1"; name="$2"; idx=0; out="${DEST_DIR}/${name}.png"
  while [ -e "$out" ]; do idx=$((idx+1)); suf=$(printf "_%c" $((96+idx))); out="${DEST_DIR}/${name}${suf}.png"; done
  mv -n "$src" "$out" && echo "$out"
}

# Przenieś wszystkie pobrane pliki
DOWNLOADS=(/tmp/playwright-mcp-files/headless/ChatGPT-Image*.png)
SAVED=""
for f in "${DOWNLOADS[@]}"; do p=$(move_one "$f" "$BASE"); [ -n "$p" ] && SAVED+="$p\n"; done
```

### 4) Aktualizacje w TODOIT

```javascript
// Oznacz pobieranie jako ukończone
await mcp__todoit__todo_set_item_property({
  list_key: SOURCE_LIST, item_key: sceneKey, 
  property_key: "image_downloaded", property_value: "completed"
});

// Sprawdź czy wszystkie etapy ukończone i ustaw status główny
const imageGenerated = await mcp__todoit__todo_get_item_property({
  list_key: SOURCE_LIST, item_key: sceneKey, property_key: "image_generated"
});
if (imageGenerated?.property_value === "completed") {
  await mcp__todoit__todo_update_item_status({
    list_key: SOURCE_LIST, item_key: sceneKey, status: "completed"
  });
}
```

### 5) Sprzątanie

```javascript
await mcp__playwright-headless__browser_close();
```

## Funkcje pomocnicze dla systemu properties

### Filtrowanie zadań gotowych do pobrania

```javascript
// Optymalna funkcja do znajdowania następnego zadania do pobrania
async function findNextDownloadTask(sourceList) {
  const result = await mcp__todoit__todo_find_items_by_property({
    list_key: sourceList,
    property_key: "image_downloaded", 
    property_value: "pending",
    limit: 1
  });
  
  if (!result.success || result.count === 0) {
    return null;
  }
  
  const item = result.items[0];
  
  // Walidacja: sprawdź czy image_generated=completed
  const imageGenerated = await mcp__todoit__todo_get_item_property({
    list_key: sourceList, item_key: item.item_key, property_key: "image_generated"
  });
  
  return imageGenerated?.property_value === "completed" ? item : null;
}
```

### Status główny na podstawie properties

```javascript
// Logika kombinacji properties → status główny
async function syncMainStatus(sourceList, itemKey) {
  const imageGenerated = await mcp__todoit__todo_get_item_property({
    list_key: sourceList, item_key: itemKey, property_key: "image_generated"
  });
  const imageDownloaded = await mcp__todoit__todo_get_item_property({
    list_key: sourceList, item_key: itemKey, property_key: "image_downloaded"
  });
  
  const genStatus = imageGenerated?.property_value || "pending";
  const dlStatus = imageDownloaded?.property_value || "pending";
  
  let mainStatus;
  if (genStatus === "failed" || dlStatus === "failed") {
    mainStatus = "failed";
  } else if (genStatus === "completed" && dlStatus === "completed") {
    mainStatus = "completed";
  } else if (genStatus === "pending" && dlStatus === "pending") {
    mainStatus = "pending";
  } else {
    mainStatus = "in_progress";
  }
  
  await mcp__todoit__todo_update_item_status({
    list_key: sourceList, item_key: itemKey, status: mainStatus
  });
}
```

## Przykłady użycia funkcji MCP

### Znajdowanie zadań gotowych do pobrania

```javascript
// Znajdź pierwsze zadanie gotowe do pobrania dla konkretnej książki
const nextTask = await mcp__todoit__todo_find_items_by_property({
  list_key: "0037_wuthering_heights",
  property_key: "image_downloaded", 
  property_value: "pending",
  limit: 1
});

if (nextTask.success && nextTask.count > 0) {
  console.log(`Znaleziono zadanie do pobrania: ${nextTask.items[0].item_key}`);
}

// Sprawdź wszystkie zadania z ukończonym generowaniem
const generatedTasks = await mcp__todoit__todo_find_items_by_property({
  list_key: "0037_wuthering_heights",
  property_key: "image_generated", 
  property_value: "completed"
});

console.log(`Zadania z ukończonym generowaniem: ${generatedTasks.count}`);
```

### Monitoring stanu zadań

```javascript
// Sprawdź wszystkie zadania w trakcie pobierania
const inProgressDownloads = await mcp__todoit__todo_find_items_by_property({
  list_key: "0037_wuthering_heights",
  property_key: "image_downloaded", 
  property_value: "in_progress"
});

// Sprawdź zadania które się nie powiodły
const failedTasks = await mcp__todoit__todo_find_items_by_property({
  list_key: "0037_wuthering_heights",
  property_key: "image_downloaded", 
  property_value: "failed"
});

console.log(`W trakcie: ${inProgressDownloads.count}, Nieudane: ${failedTasks.count}`);
```

### Debugowanie właściwości zadań

```javascript
// Sprawdź konkretne właściwości zadania
const threadId = await mcp__todoit__todo_get_item_property({
  list_key: "0037_wuthering_heights",
  item_key: "scene_01",
  property_key: "thread_id"
});

const imageStatus = await mcp__todoit__todo_get_item_property({
  list_key: "0037_wuthering_heights",
  item_key: "scene_01", 
  property_key: "image_downloaded"
});

console.log(`Scene 01 - Thread: ${threadId?.property_value}, Status: ${imageStatus?.property_value}`);
```
