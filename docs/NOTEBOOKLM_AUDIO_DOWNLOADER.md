# NotebookLM Audio Download Orchestrator

## Overview

The NotebookLM Audio Download Orchestrator is a specialized agent for automating the complete download workflow for audio files generated by NotebookLM. It integrates with the TODOIT task management system and uses browser automation to safely download, organize, and track audio files across multiple languages.

## Features

### Core Functionality
- **Automated Discovery**: Finds pending audio download tasks from TODOIT system
- **Browser Automation**: Uses MCP playwright-cdp for NotebookLM interface interaction
- **File Organization**: Downloads and organizes audio files by book and language
- **Task Tracking**: Updates TODOIT status and saves file paths for integration
- **Safety Mechanisms**: Implements verification and error handling throughout the process
- **Optional Cleanup**: Can safely delete audio from NotebookLM after successful download

### Integration Points
- **TODOIT MCP Tools**: Task discovery, status updates, property management
- **Playwright-CDP MCP**: Browser automation for NotebookLM interaction
- **File System**: Organized storage in project book directories
- **37degrees Project**: Seamless integration with existing book workflow

## Architecture

### Agent Structure

```
a8-afa-notebook-audio-dwn/
├── Agent Definition (.claude/agents/a8-afa-notebook-audio-dwn.md)
├── Implementation (.claude/agents/a8-afa-notebook-audio-dwn.py)
├── Standalone Script (scripts/notebooklm-audio-downloader.py)
└── Documentation (docs/NOTEBOOKLM_AUDIO_DOWNLOADER.md)
```

### Workflow Steps

1. **Task Discovery**
   - Query TODOIT for pending audio_dwn_* subitems
   - Extract book information and language codes
   - Retrieve saved NotebookLM URLs and titles

2. **Browser Navigation**
   - Navigate to NotebookLM Studio interface
   - Search for audio files matching book and language
   - Identify correct audio using title patterns

3. **Download Process**
   - Click More menu for target audio
   - Select Download option
   - Monitor download progress with timeout
   - Verify download completion

4. **File Organization**
   - Move from temp directory to book/audio/
   - Rename with standard format: {book_key}_{language}.mp4
   - Verify file integrity and size

5. **Task Management**
   - Update subitem status to "completed"
   - Save file path as property
   - Record completion timestamp

6. **Optional Cleanup**
   - Verify local file safety
   - Delete audio from NotebookLM
   - Log deletion for audit trail

## Usage

### Agent Invocation

The agent is designed to be invoked through Claude Code's agent system:

```bash
# Invoke through Claude Code
/agent a8-afa-notebook-audio-dwn
```

### Standalone Script

The orchestrator can also be run as a standalone script:

```bash
# Process all pending downloads
python scripts/notebooklm-audio-downloader.py --auto

# Process specific task
python scripts/notebooklm-audio-downloader.py --task-id 0011_gullivers_travels --language pl

# Dry run mode (no actual changes)
python scripts/notebooklm-audio-downloader.py --auto --dry-run

# Enable cleanup after download
python scripts/notebooklm-audio-downloader.py --auto --cleanup
```

### Script Options

- `--auto`: Process all pending downloads automatically
- `--task-id ID`: Process specific task by book key
- `--language LANG`: Language code (pl, en, fr, de, etc.)
- `--dry-run`: Simulate without making actual changes
- `--cleanup`: Enable NotebookLM cleanup after successful downloads
- `--verbose`: Show detailed progress information

## TODOIT Integration

### Task Structure

The agent works with tasks in the "cc-au-notebooklm" list:

```
Parent Item: {book_key} (e.g., "0011_gullivers_travels")
├── Title: "Audio for {Book Title} by {Author}"
├── Status: "in_progress"
└── Subitems:
    ├── audio_dwn_pl (status: pending → completed)
    ├── audio_dwn_en (status: pending → completed)
    ├── audio_dwn_fr (status: pending → completed)
    └── ... (other languages)
```

### Properties Used

#### List Properties
- `nb_url`: NotebookLM notebook URL
- `last_processed`: Timestamp of last agent run

#### Item Properties
- `nb_au_title_{lang}`: Saved audio title for language
- `file_path`: Local file path after download
- `downloaded_at`: Completion timestamp
- `deleted_from_notebooklm`: Cleanup timestamp (if performed)

### Required MCP Tools

The agent uses these TODOIT MCP tools:

- `mcp__todoit__todo_find_items_by_status`: Discover pending tasks
- `mcp__todoit__todo_get_item`: Retrieve task details
- `mcp__todoit__todo_get_item_property`: Get saved URLs and titles
- `mcp__todoit__todo_update_item_status`: Mark tasks complete
- `mcp__todoit__todo_set_item_property`: Save file paths and timestamps

## Browser Automation

### Required MCP Tools

The agent uses these Playwright-CDP MCP tools:

- `mcp__playwright-cdp__browser_navigate`: Navigate to NotebookLM
- `mcp__playwright-cdp__browser_snapshot`: Capture interface state
- `mcp__playwright-cdp__browser_evaluate`: Search for audio in DOM
- `mcp__playwright-cdp__browser_click`: Click More and Download buttons
- `mcp__playwright-cdp__browser_wait_for`: Wait for download completion

### NotebookLM Interface Navigation

1. **Studio Tab**: Audio files are located in the Studio section
2. **Audio Cards**: Each audio has a card with title, metadata, and More button
3. **More Menu**: Contains Download, Share, Rename, and Delete options
4. **Download Process**: Initiates browser download to temp directory

### Audio Identification

The agent identifies target audio files by:

- **Title Matching**: Search for book titles in various languages
- **Language Patterns**: Recognize Polish, English, French, etc. content
- **Metadata Analysis**: Use timestamps and source information
- **Fallback Search**: Pattern-based matching when exact titles unavailable

## File Organization

### Directory Structure

Audio files are organized following the project convention:

```
books/
├── 0001_alice_in_wonderland/
│   └── audio/
│       ├── 0001_alice_in_wonderland_pl.mp4
│       ├── 0001_alice_in_wonderland_en.mp4
│       └── 0001_alice_in_wonderland_fr.mp4
├── 0011_gullivers_travels/
│   └── audio/
│       ├── 0011_gullivers_travels_pl.mp4
│       └── 0011_gullivers_travels_en.mp4
└── ...
```

### File Naming Convention

- Format: `{book_key}_{language_code}.mp4`
- Book key: Zero-padded number + underscore + name (e.g., "0011_gullivers_travels")
- Language codes: pl, en, fr, de, es, pt, hi, ja, ko, etc.

### File Verification

After download and organization, the agent verifies:

- File exists at target location
- File size is reasonable (> 1MB)
- File was created recently (within download timeframe)
- No corruption during transfer

## Error Handling

### Common Issues and Recovery

1. **Audio Not Found**
   - Cause: Audio not generated yet, wrong title, interface changes
   - Recovery: Skip task, log error, continue with other tasks

2. **Download Timeout**
   - Cause: Slow network, large file, NotebookLM issues
   - Recovery: Retry with longer timeout, fallback to manual download

3. **File Organization Failure**
   - Cause: Permission issues, disk space, path problems
   - Recovery: Try alternative paths, manual intervention required

4. **Task Update Failure**
   - Cause: TODOIT connection issues, invalid task structure
   - Recovery: Continue with download, retry update later

### Safety Mechanisms

- **Dry Run Mode**: Test workflow without making changes
- **File Verification**: Multiple checks before marking tasks complete
- **Rollback Capability**: Ability to restore from temp directory
- **Audit Trail**: Complete logging of all operations

## Security Considerations

### Download Safety

- Only download from verified NotebookLM URLs
- Verify file integrity and format before organization
- Use isolated temporary directory for downloads
- Implement timeout and size limits for downloads

### Cleanup Safety

The optional cleanup feature includes multiple safety checks:

1. **Local File Verification**: File must exist locally and be recent
2. **Size Validation**: File must have reasonable size (> 1MB)
3. **Error Check**: No errors during download process
4. **User Confirmation**: Cleanup must be explicitly enabled
5. **Audit Trail**: Log all deletion operations with timestamps

### Access Control

- Browser automation uses authenticated NotebookLM session
- File operations respect system permissions
- TODOIT operations use authorized MCP connections
- No credential exposure in logs or output

## Performance Optimization

### Batch Processing

- Process multiple downloads in sequence
- Add delays between downloads to avoid rate limiting
- Efficient task discovery with filtered queries
- Parallel file operations where safe

### Resource Management

- Clean up temporary files after successful organization
- Monitor disk space during downloads
- Limit concurrent browser operations
- Timeout long-running operations

### Caching and Reuse

- Reuse browser session for multiple downloads
- Cache audio discovery results within session
- Skip already completed tasks efficiently
- Minimize TODOIT API calls

## Monitoring and Logging

### Progress Reporting

The agent provides detailed progress information:

- Task discovery summary
- Individual download progress
- File organization status
- Final success/failure report

### Error Logging

- Comprehensive error messages with context
- Stack traces for debugging
- Recovery suggestions for common issues
- Integration with project logging systems

### Metrics Collection

- Download success/failure rates
- Processing time per audio file
- File size and quality metrics
- System resource usage

## Integration Examples

### Basic Agent Usage

```python
# Invoke through Claude Code agent system
agent = Task(subagent_type="a8-afa-notebook-audio-dwn",
             prompt="Download all pending audio files")
```

### Scripted Automation

```bash
#!/bin/bash
# Download audio for new books automatically

# Process all pending downloads
python scripts/notebooklm-audio-downloader.py --auto

# Check for errors
if [ $? -eq 0 ]; then
    echo "All downloads completed successfully"
else
    echo "Some downloads failed - check logs"
fi
```

### Pipeline Integration

```python
# Integration with book processing pipeline
def process_book_audio(book_key):
    # Generate audio in NotebookLM (separate process)
    generate_notebooklm_audio(book_key)

    # Download using orchestrator
    result = run_audio_downloader(book_key)

    # Continue with next pipeline step
    if result.success:
        process_transcription(book_key)
```

## Troubleshooting

### Common Problems

1. **"No pending tasks found"**
   - Check TODOIT task structure
   - Verify audio generation completed
   - Confirm task status is "pending"

2. **"Audio not found in interface"**
   - Check NotebookLM URL is correct
   - Verify audio generation completed
   - Update search patterns if interface changed

3. **"Download failed"**
   - Check network connectivity
   - Verify NotebookLM session is active
   - Try manual download to test

4. **"File organization failed"**
   - Check directory permissions
   - Verify disk space available
   - Ensure book directory structure exists

### Debug Mode

Enable verbose output for detailed troubleshooting:

```bash
python scripts/notebooklm-audio-downloader.py --auto --verbose --dry-run
```

### Manual Recovery

If automated process fails, manual recovery steps:

1. Check temp download directory: `/tmp/playwright-mcp-output/`
2. Manually organize files to proper locations
3. Update TODOIT task status manually
4. Investigate root cause for future automation

## Future Enhancements

### Planned Features

- **Multi-language Batch Processing**: Download all languages for a book in one operation
- **Quality Verification**: Audio format and content validation
- **Retry Logic**: Automatic retry with exponential backoff
- **Progress Persistence**: Resume interrupted batch operations
- **Notification System**: Slack/email notifications for completion

### Integration Opportunities

- **Transcription Pipeline**: Automatic transcription after download
- **Quality Analysis**: Audio quality metrics and validation
- **Distribution System**: Upload to CDN or streaming services
- **Analytics Dashboard**: Download metrics and success rates

## Support and Maintenance

### Version Information

- Current Version: 1.0.0
- Last Updated: 2025-09-17
- Compatibility: Claude Code MCP system
- Dependencies: playwright-cdp, todoit MCP tools

### Getting Help

- **Documentation**: This file and inline code comments
- **Issues**: Report problems through project issue tracker
- **Updates**: Check for agent updates in .claude/agents/ directory
- **Community**: Project-specific support channels

### Maintenance Tasks

- **Regular Updates**: Keep MCP tool dependencies current
- **Interface Changes**: Monitor NotebookLM interface for changes
- **Performance Tuning**: Optimize download speeds and error rates
- **Security Reviews**: Regular security assessment of download process